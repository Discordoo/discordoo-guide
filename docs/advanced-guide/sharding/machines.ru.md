# Межмашинный шардинг
В случае очень больших ботов, один сервер физически не может предоставить столько вычислительной мощности единожды, чтобы бот мог оставаться только на нём. 
Для решения этой проблемы в Discordoo существует механизм межмашинного шардинга. Бот делится на несколько серверов и исполняется параллельно.

## ПРЕДУПРЕЖДЕНИЕ
**ЭТОТ ФУНКЦИОНАЛ ЕЩЁ НЕ ВВЕДЁН.**

## Подготовка серверов
Вам нужно подготовить ваши сервера для того чтобы они могли исполнять экземпляры шардинга. Чтобы это сделать, вам необходимо в вашем firewall открыть порт, который вы указали для использования в опциях основного менеджера шардов. Если вы не указали порт, то по умолчанию используется 8379.

## Начнём
На каждом сервере вы должны установить Discordoo, создать копию вашего бота и перевести менеджер шардов в режим ожидания, затем запустить все менеджеры шардов:

=== "TS"
```ts
import { ShardingManager, ShardingManagerModes } from 'discordoo'

const manager = new ShardingManager({
  file: 'C:/путь/к/вашему/файлу/старта.js',
  mode: ShardingManagerModes.MACHINES,
  machines: {
    me: 'child', // (вторичный) определяет, является ли менеджер шардов главным или вторичным
    ipc: {
      networkHost: 'айпи сервера на котором запущен этот менеджер шардов',
    //networkPort: 9999, // опционально можно сменить порт, использующщийся для пересылки сообщений между серверами
    },
    /*tls: { // опции шифрования передаваемых между серверами данных (РЕКОМЕНДОВАНО)
      // сертификат public также используется в массиве доверенных сертификатов (trustedConnections) 
      // на машине главного менеджера шардов
      public: string // путь к сертификату
      private: string // путь к приватному ключу сертификата
      dhparam?: string // опционально путь к dhparam, 
      requestCert?: boolean // опционально, true если главный шардинг менеджер обязан предоставить сертификат 
      rejectUnauthorized?: boolean // отключать неавторизованные подключения 
      // массив путей к доверенным сертификатам, 
      // в данном случае 1 путь - к сертификату машины главного менеджера шардов 
      trustedConnections?: string[]
    },*/
  },
})

manager.start()
```
На главном сервере вам нужно создать и запустить менеджер шардов в режиме "главный":

(необязательно выделять отдельный сервер под главный менеджер шардов, удалённым хостом может быть и localhost)
=== "TS"
```ts
import { ShardingManager, ShardingManagerModes, ChildShardingModes } from 'discordoo'

const manager = new ShardingManager({
  mode: ShardingManagerModes.MACHINES,
  machines: {
    me: 'parent', // (главный) определяет, является ли менеджер шардов главным или вторичным
    points: [ // массив точек соприкосновения с вашими серверами
      {
        port: 8379, // опциональное использование другого порта для пересылки сообщений
        host: '10.0.18.1', // айпи удалённого хоста (обязательно!)
        udp: 'udp4', // опциональное использование протокола UDP вместо TCP
        childManagerOptions: { // опции менеджера шардов, которые будут отправлены на удалённую машину
          mode: ChildShardingModes.PROCESSES,
          shards: { from: 0, to: 127 }, // запустить шарды с 0 по 127
        },
        tls: {
          // сертификат public используется в массиве trustedConnections на удалённом хосте
          public: '../tls/client.pub', // сертификат для главного менеджера шардов 
          private: '../tls/client.key', // приватный ключ сертификата
          rejectUnauthorized: true, // отключать неавторизованные подключения
          trustedConnections: [ '../tls/10-0-18-1.pub', '../tls/FE80::0202:B3FF:FE1E:8329.pub' ] // сертификаты с удалённых машин
        },
      },
      {
        host: 'FE80::0202:B3FF:FE1E:8329', // ipv6 также поддерживается
        childManagerOptions: {
          mode: ChildShardingModes.WORKERS,
          shards: { from: 128, to: 255 }, // запустить шарды с 128 по 255
        },
        tls: {
          public: '../tls/server.pub',
          private: '../tls/server.key',
          rejectUnauthorized: true,
          trustedConnections: [ '../tls/10-0-18-1.pub', '../tls/FE80::0202:B3FF:FE1E:8329.pub' ]
        },
      }
    ]
  }
})

manager.start()
```
Готово! Теперь ваш бот разделён на несколько серверов и может продолжать расти. Вам ничего переписывать не нужно, важно только лишь обеспечить быстрое соединение между серверами, иначе большая задержка между отправкой и получением сообщений будет тормозить вашего бота. По нашему мнению, максимально возможная задержка пинг-понг пакетов должна не превышать 50 миллисекунд. В ином случае, задержка станет ощутимой для пользователей. 
