# Идентификаторы 
DiscordooSnowflake это расширенная версия идентификаторов Twitter.

## Зачем нам это
Мы решили создать собственные идентификаторы, такие же как создаёт Discord или Twitter, для того чтобы идентифицировать процессы, созданные ddoo и для пометки сообщений между ними.
Т.к. межпроцессное взаимодействие сводится лишь к тому, что мы принимаем и отправляем события (а с ними сообщения), нужен был быстрый способ для идентификации этих сообщений, ведь мы не можем просто так взять и получить ответ, нужно понять что этот ответ пришёл именно на наш запрос.

![sharding-snowflakes](../../assets/sharding-snowflakes.png)

## Разбираемся в строении идентификаторов (snowflake => снежинка)
У нас есть снежинка `1128425170719486862453931925225603077`, мы можем перевести её в двоичную систему счисления:
```
128                                        86                               54                               22
000000001101100101010011101010000000011011 00000000000000000000000000001011 00000000000000000000000001100011 0000000000000000000101
  время, прошедшее с Discordoo epoch (мс)            айди воркера                     айди шарда                    прирост
```
После этой операции, с помощью побитовых операторов JavaScript мы можем разобрать снежинку по частям.

Узнаём временную метку, которую вписали в снежинку когда она была создана:
```ts
const EPOCH = 1609459200000 // EPOCH это временная метка, обозначающая 2021-01-01T00:00:00.000Z
const timestamp = (BigInt(snowflake) >> 86n) + BigInt(EPOCH) // время создания снежинки - 1624043753498n 
```

Узнаём айди воркера (обычно это айди процесса на котором сгенерировали снежинку)
```ts
const workerID = (BigInt(snowflake) & 0x3FFFFFFFC0000000000000n) >> 54n // 11n
```

Узнаём айди экземпляра кластеризации (айди шарда, но не Discord WebSocket шарда)
```ts
const shardID = (BigInt(snowflake) & 0x3FFFFFFFC00000n) >> 22n // 99n
```
 
И наконец узнаём "прирост" (число, которое увеличивается на 1 каждый раз, когда новая снежинка генерируется на одном и том же процессе)
```ts
const increment = BigInt(snowflake) & 0x3FFFFFn // 5n
```
